<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoPoP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <script>
        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            var closeButton = document.querySelector('.sidebar .close-button');

            sidebar.classList.toggle('show-sidebar');

            setTimeout(function() {
                closeButton.classList.toggle('show-close-button');
            }, 200);
        }

        function closeSidebar() {
            var sidebar = document.getElementById('sidebar');
            var closeButton = document.querySelector('.sidebar .close-button');

            sidebar.classList.remove('show-sidebar');
            closeButton.classList.remove('show-close-button');
        }

        function checkIfUserIsLoggedIn() {
            return;
        }
        
        async function checkLoginAndRedirect() {
            // ì„œë²„ì—ì„œ ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ë ¤ë©´ fetchë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            try {
                const response = await fetch('/check-login');
                const data = await response.json();

                if (data.isLoggedIn) {
                    // ë¡œê·¸ì¸ë˜ë©´ ì„¸ì…˜ ê°’ì„ ì„¤ì •í•˜ê³  ë¦¬ë””ë ‰ì…˜í•©ë‹ˆë‹¤.
                    await fetch('/set-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ isLoggedIn: true, userId: data.userId }),
                    });

                    window.location.href = '/mypage.html';
                } else {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            fetch('/check-master')
                .then(response => response.json())
                .then(data => {
                    if (data.isMaster) {
                        document.getElementById('writeButton').style.display = 'block';
                    }
                })
                .catch(error => console.error('ì„¸ì…˜ í™•ì¸ ì˜¤ë¥˜:', error));


            fetch('/get-popup-data')
                .then(response => response.json())
                .then(data => {
                    data.forEach(popup_store => {
                        createPopupCard(popup_store);
                    });
                })
                .catch(error => console.error('íŒì—… ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error));
        });

        function redirectToPopupWrite() {
            window.location.href = 'popup_write.html';
        }

        function createPopupCard(popup_store) {
            const popupCard = document.createElement('div');
            popupCard.className = 'popup-card';

            popupCard.innerHTML = `
                <div class="ppp">
                    <div class="sign-card">
                        <div class="sign-popup">
                            <p>íŒì—… ìŠ¤í† ì–´</p>
                        </div>
                    </div>
                    <button class="btn-like">ğŸ¤</button>
                    <img src="/uploads/${popup_store.picture_path}" class="popup_img">
                </div>
                <a class="card-surface">
                    <div class="card-inner">
                        <div class="txt_wrap">
                            <p class="txt_card_title">${popup_store.title}</p>
                            <p class="txt_card_location">${popup_store.location}</p>
                            <hr class="card-line">
                        </div>
                        <div class="txt_event">íŒì—…ê¸°ê°„
                            <span class="term">${popup_store.date}</span>
                        </div>
                    </div>
                </a>
            `;

            document.querySelector('.card-containers').appendChild(popupCard);
        }
    </script>
</head>
<body>
    <div class="header">
        <div class="outer">
            <div class="list" onclick="toggleSidebar()"></div>
            <a class="logo">PoPoP</a>
            <div class="header-menu">
                <a class="account" href="#" onclick="checkLoginAndRedirect()"></a>
            </div>
        </div>
    </div>
    <div id="sidebar" class="sidebar">
        <span class="close-button" role="button" onclick="closeSidebar()"></span>
        <ul>
            <li><a href="#" class="menu-item">íŒì—…ìŠ¤í† ì–´</a></li>
            <li><a href="space_lease.html" class="menu-item">ê³µê°„ ëŒ€ê´€</a></li>
            <li><a href="events.html" class="menu-item">ì „êµ­ í–‰ì‚¬</a></li>
        </ul>
    </div>
    <div>
        <button id="writeButton" onclick="redirectToPopupWrite()" style="display: none; margin: 10px; font-size: 15px; font-weight: bold; ">íŒì—…ìŠ¤í† ì–´ ë“±ë¡í•˜ê¸°</button>
        <div class="card-containers">
             
        </div>
    </div>
</body>
</html>
